<style>
.info_summary {
  display: none;
}

#topics {
  border: 1px solid #efefef;
}
  #topics tr th{
    color: #efefef;
    text-align: left;
    background-color: #000044;
  }

  #topics tr td{
  }

  #topics tr{
    background-color: #efefef;
  }
</style>

<script type="text/javascript">
$(document).ready(function(){
  $("#topics tr.data:even").css("background-color", "#efefef");
  $("#topics tr.data:odd").css("background-color", "#bfbfbf");

  $("#topics tr.data").hover(function(){
    $(this).css("background", "#aaa");
  },function(){
    $(this).css("background", "");
  });

  $(".more_info").click(function( e ){
    $("#article_"+ $(this).attr( "article_id" )).toggle({
      duration: 550
    });
  });

  $("#force_refresh").click(function(){
    $.ajax({
      url: "/topic/<%= topic.topic_id %>/refresh",
      success: function(){
        window.location = window.location
      }
    })
  });
});
</script>

<h1><%= topic.topic_name %></h1>

<div>
  <a href="/topic/add_source?topic_id=<%= topic.topic_id %>">Add source article</a>
  | <span id="force_refresh">Force refresh</span>
  | <span><a href="/">Home</a></span>
</div>

<% if subject_importance_map != nil && subject_importance_map['map'] != nil %>
<h2>subject_importance_map</h2>
<% subject_importance_map['map'].each do |subject, info| %>
<div>
  <span><%= subject %> ( <%= '%.2f' % info['salience'] %> ): </span>
  <% info['mention_map'].sort_by{|k,v| v['cnt'].to_f }.reverse.to_h.each do |k,v| %>
    <span><%= k %> (<%= '%.2f' % v['cnt'] %> )</span>
  <% end %>
</div>
<% end %>
<% end %>

<table id="topics" class="display" cellspacing="0" width="100%">
  <tr>
    <th>Info</th>
    <th>Title</th>
    <th>Source</th>
    <th>Link</th>
    <th>Score</th>
    <th>Magnitude</th>
  </tr>

  <% articles.each do |article| %>
  <% next if !article.has_body? %>
  <tr class="data">
    <td><p class="more_info" article_id="<%= article.article_id %>">Summary</p></td>
    <td><a href="/article/<%= article.article_id %>"><%= article.data['article']['title'] %></a></td>
    <td><%= article.source %></td>
    <td><a href="<%= article.url %>" target="_new">Link</a></td>
    <td><%= "%.3f" % article.score.to_f %></td>
    <td><%= "%.3f" % article.magnitude.to_f %></td>

  </tr> <tr id="article_<%= article.article_id %>" class="info_summary">
    <td colspan="6" style="vertical-align: top;">
    <table style="width: 100%;">
    <tr>
      <% if topic.has_summary? && topic.has_summary_for_article?( article.article_id ) %>
      <% summary = topic.get_summary_for_article( article.article_id ) %>
      <% summary['mr'].each do |context, info| %>
      <td style="vertical-align: top; width: 20%;">
        <h4><%= context %></h4>
        <% info.sort_by{|k,v| v['pct'].to_f }.reverse.to_h.each do |name, c_info| %>
        <table style="width: 100%;">
        <tr>
          <td style="width: 50%;"><%= name %></td>
          <td><%= c_info['cnt'].to_f %></td>
          <td><%= "%.2f" % c_info['pct'].to_f %>%</td>
        </tr>
        </table>
        <% end %>
      </td>
      <% end %>
      <% end %>
    </tr>
    </table>
    </td>
  </tr>
  <% end %>

</table>

